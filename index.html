<!DOCTYPE html>
<html>
<head>
    <title>Web Mathematica Clone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.24.1/plotly.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .cell {
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden;
        }

        .input-area {
            background-color: #f1f1f1;
            padding: 10px;
            display: flex;
        }

        .cell-number {
            color: #666;
            font-family: monospace;
            margin-right: 10px;
            user-select: none;
        }

        .input-field {
            flex-grow: 1;
            font-family: monospace;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        .output-area {
            background-color: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-top: none;
            font-family: monospace;
            min-height: 20px;
        }

        .error {
            color: #d32f2f;
        }

        .history-display {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .plot-container {
            width: 100%;
            height: 400px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="notebook">
        <div class="cell">
            <div class="input-area">
                <span class="cell-number">In[*]:</span>
                <input type="text" class="input-field" placeholder="Enter mathematical expression...">
            </div>
            <div class="output-area">
                <span class="cell-number">Out[*]:</span>
                <span class="result"></span>
            </div>
        </div>
    </div>
    <div class="history-display">
        <h3>Current Variable State:</h3>
        <pre id="variableState"></pre>
    </div>

    <script>
        const notebook = document.getElementById('notebook');
        const variableState = document.getElementById('variableState');
        let evaluationCount = 0;
        const scope = {};

        // Add plotting functions to scope
        scope.Plot = function(expr, range = [-10, 10], points = 100) {
            const [start, end] = range;
            const step = (end - start) / points;
            const x = [], y = [];
            
            // Create a function from the expression
            let fn;
            if (typeof expr === 'string') {
                fn = math.compile(expr);
            } else if (typeof expr === 'function') {
                fn = expr;
            } else {
                throw new Error('Expression must be a string or function');
            }

            // Generate points
            for (let i = 0; i <= points; i++) {
                const xVal = start + i * step;
                x.push(xVal);
                try {
                    const yVal = fn.evaluate({x: xVal});
                    y.push(yVal);
                } catch (e) {
                    y.push(null);
                }
            }

            return {
                type: 'plot',
                data: [{ x, y, type: 'scatter', mode: 'lines' }],
                layout: {
                    title: `Plot of ${expr}`,
                    xaxis: { title: 'x' },
                    yaxis: { title: 'y' }
                }
            };
        };

        scope.Plot2D = function(points) {
            return {
                type: 'plot',
                data: [{
                    x: points.map(p => p[0]),
                    y: points.map(p => p[1]),
                    mode: 'markers',
                    type: 'scatter'
                }],
                layout: {
                    title: '2D Plot',
                    xaxis: { title: 'x' },
                    yaxis: { title: 'y' }
                }
            };
        };

        function createNewCell() {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.innerHTML = `
                <div class="input-area">
                    <span class="cell-number">In[*]:</span>
                    <input type="text" class="input-field" placeholder="Enter mathematical expression...">
                </div>
                <div class="output-area">
                    <span class="cell-number">Out[*]:</span>
                    <span class="result"></span>
                </div>
            `;
            notebook.appendChild(cell);
            return cell.querySelector('.input-field');
        }

        function updateVariableState() {
            const stateDisplay = Object.entries(scope)
                .filter(([key, value]) => !key.startsWith('_') && typeof value !== 'function')
                .map(([key, value]) => `${key} = ${JSON.stringify(value)}`)
                .join('\n');
            variableState.textContent = stateDisplay;
        }

        function updateCellNumbers(currentCell, evaluationNumber) {
            const inputLabel = currentCell.querySelector('.input-area .cell-number');
            const outputLabel = currentCell.querySelector('.output-area .cell-number');
            inputLabel.textContent = `In[${evaluationNumber}]:`;
            outputLabel.textContent = `Out[${evaluationNumber}]:`;
        }

        function displayOutput(result, outputElement) {
            if (result && result.type === 'plot') {
                // Create a container for the plot
                const plotContainer = document.createElement('div');
                plotContainer.className = 'plot-container';
                outputElement.appendChild(plotContainer);
                
                // Create the plot
                Plotly.newPlot(plotContainer, result.data, result.layout);
                return plotContainer;
            } else {
                // Regular output
                outputElement.textContent = math.format(result, {precision: 14});
                return result;
            }
        }

        function evaluateExpression(input, cell) {
            const outputArea = cell.querySelector('.output-area');
            const outputElement = outputArea.querySelector('.result');
            outputElement.innerHTML = ''; // Clear previous output
            
            try {
                evaluationCount++;
                updateCellNumbers(cell, evaluationCount);
                
                // Evaluate the expression in the persistent scope
                const result = math.evaluate(input, scope);
                
                // Display the result
                const displayedResult = displayOutput(result, outputElement);
                outputElement.className = 'result';
                
                // Store the result in a special variable
                scope[`_${evaluationCount}`] = displayedResult;
                
                // Update the variable state display
                updateVariableState();
                
                return true;
            } catch (error) {
                outputElement.textContent = error.message;
                outputElement.className = 'result error';
                return false;
            }
        }

        // Handle input events
        notebook.addEventListener('keydown', (event) => {
            if (event.target.classList.contains('input-field') && event.key === 'Enter') {
                const currentCell = event.target.closest('.cell');
                const success = evaluateExpression(event.target.value, currentCell);
                
                // Only create a new cell if this isn't the last cell
                const isLastCell = currentCell === notebook.lastElementChild;
                if (success && isLastCell) {
                    const newInput = createNewCell();
                    newInput.focus();
                }
            }
        });

        // Focus the first input field
        document.querySelector('.input-field').focus();
    </script>
</body>
</html>